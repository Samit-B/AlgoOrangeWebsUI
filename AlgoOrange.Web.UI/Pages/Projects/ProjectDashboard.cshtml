@page
<div class="content">
    <div class="row gy-3 mb-6 justify-content-between">
        <div class="col-md-9 col-auto">
            <h2 class="mb-2 text-body-emphasis">Projects Dashboard </h2>
            <h5 class="text-body-tertiary fw-semibold">Here’s what’s going on at your business right now</h5>
        </div>
        <div class="col-md-3 col-auto">
            <div class="flatpickr-input-container">
                <input class="form-control ps-6 datetimepicker" id="datepicker" type="text" data-options='{"dateFormat":"M j, Y","disableMobile":true,"defaultDate":"Mar 1, 2022"}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
            </div>
        </div>
    </div>
    <div class="row mb-3 gy-6">
        <div class="col-12 col-xxl-2">
            <div class="row align-items-center g-3 g-xxl-0 h-100 align-content-between">
                <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
                    <div class="d-flex align-items-center">
                        <span class="fs-4 lh-1 uil uil-books text-primary-dark"></span>
                        <div class="ms-2">
                            <div class="d-flex align-items-end">
                                <h2 class="mb-0 me-2">32</h2><span class="fs-7 fw-semibold text-body">Projects</span>
                            </div>
                            <p class="text-body-secondary fs-9 mb-0">Awating processing</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
                    <div class="d-flex align-items-center">
                        <span class="fs-4 lh-1 uil uil-users-alt text-success-dark"></span>
                        <div class="ms-2">
                            <div class="d-flex align-items-end">
                                <h2 class="mb-0 me-2">94</h2><span class="fs-7 fw-semibold text-body">Members</span>
                            </div>
                            <p class="text-body-secondary fs-9 mb-0">Working hard</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
                    <div class="d-flex align-items-center">
                        <span class="fs-4 lh-1 uil uil-invoice text-warning-dark"></span>
                        <div class="ms-2">
                            <div class="d-flex align-items-end">
                                <h2 class="mb-0 me-2">23</h2><span class="fs-7 fw-semibold text-body">Invoices</span>
                            </div>
                            <p class="text-body-secondary fs-9 mb-0">Soon to be cleared</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3 col-lg-6 col-xl-3 col-xxl-12">
                    <div class="d-flex align-items-center">
                        <span class="fs-4 lh-1 uil uil-refresh text-danger-dark"></span>
                        <div class="ms-2">
                            <div class="d-flex align-items-end">
                                <h2 class="mb-0 me-2">3</h2><span class="fs-7 fw-semibold text-body">Refunds</span>
                            </div>
                            <p class="text-body-secondary fs-9 mb-0">Fresh start</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-6 col-xxl-5">
            <div class="mx-xxl-0">
                <h3>Project: zero Roadmap</h3>
                <p class="text-body-tertiary">Phase 2 is now ongoing</p>
                <div class="gantt-zero-roadmap">
                    <div class="row g-2 flex-between-center mb-3">
                        <div class="col-12 col-sm-auto">
                            <div class="d-flex">
                                <div class="d-flex align-items-end me-3">
                                    <label class="form-check-label mb-0 me-2 lh-1 text-body" for="progress">Progress</label>
                                    <div class="form-check form-switch min-h-auto mb-0">
                                        <input class="form-check-input" id="progress" type="checkbox" checked="" data-gantt-progress="data-gantt-progress" />
                                    </div>
                                </div>
                                <div class="d-flex align-items-end flex-1">
                                    <label class="form-check-label mb-0 me-2 lh-1 text-body" for="links">Links</label>
                                    <div class="form-check form-switch min-h-auto flex-1 mb-0">
                                        <input class="form-check-input" id="links" type="checkbox" checked="" data-gantt-links="data-gantt-links" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-auto">
                            <div class="btn-group" role="group" data-gantt-scale="data-gantt-scale">
                                <input class="btn-check" id="weekView" type="radio" name="scaleView" value="week" checked="" />
                                <label class="btn btn-phoenix-secondary bg-body-highlight-hover fs-10 py-1 mb-0" for="weekView">Week</label>
                                <input class="btn-check" id="monthView" type="radio" name="scaleView" value="month" />
                                <label class="btn btn-phoenix-secondary bg-body-highlight-hover fs-10 py-1 mb-0" for="monthView">Month</label>
                                <input class="btn-check" id="yearView" type="radio" name="scaleView" value="year" />
                                <label class="btn btn-phoenix-secondary bg-body-highlight-hover fs-10 py-1 mb-0" for="yearView">Year</label>
                            </div>
                        </div>
                    </div>
                    <div class="gantt-zero-roadmap-chart"></div>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-6 col-xxl-5">
            <div class="card border h-100 w-100 overflow-hidden">
                <div class="bg-holder d-block bg-card" style="background-image:url(../assets/img/spot-illustrations/32.png);background-position: top right;">
                </div>
                <!--/.bg-holder-->

                <div class="d-dark-none">
                    <div class="bg-holder d-none d-sm-block d-xl-none d-xxl-block bg-card" style="background-image:url(../assets/img/spot-illustrations/21.png);background-position: bottom right; background-size: auto;">
                    </div>
                    <!--/.bg-holder-->

                </div>
                <div class="d-light-none">
                    <div class="bg-holder d-none d-sm-block d-xl-none d-xxl-block bg-card" style="background-image:url(../assets/img/spot-illustrations/dark_21.png);background-position: bottom right; background-size: auto;">
                    </div>
                    <!--/.bg-holder-->

                </div>
                <div class="card-body px-5 position-relative">
                    <div class="badge badge-phoenix fs-10 badge-phoenix-warning mb-4"><span class="fw-bold">Coming soon</span><span class="fa-solid fa-award ms-1"></span></div>
                    <h3 class="mb-5">Early bird gets the warm leads!</h3>
                    <p class="text-body-tertiary fw-semibold">Phoenix CRM Dashboard is coming to <br class="d-none d-sm-block" />market soon for fulfilling your every <br class="d-none d-sm-block" />CRM related needs. </p>
                </div>
                <div class="card-footer border-0 py-0 px-5 z-1">
                    <p class="text-body-tertiary fw-semibold">Follow <a href="https://themewagon.com/">ThemeWagon </a>at <br class="d-none d-xxl-block" />Bootstrap Marketplace for updates.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-7 pb-3 border-y">
        <div class="row">
            <div class="col-12 col-xl-7 col-xxl-6">
                <div class="row g-3 mb-3">
                    <div class="col-12 col-md-6">
                        <h3 class="text-body-emphasis text-nowrap">Issues Discovered
                        <button class="btn btn-link p-0 text-body fs-6" type="button" id="Issues-button" data-bs-toggle="tooltip" data-bs-placement="top" title="Chatbot for issues">
                            <span class="fa-solid fa-info-circle"></span>
                        </button>
                        </h3>
                        <p class="text-body-tertiary mb-md-7">Newly found and yet to be solved</p>
                        <div class="d-flex align-items-center justify-content-between">
                            <p class="mb-0 fw-bold">Issue type </p>
                            <p class="mb-0 fs-9">Total count <span class="fw-bold">257</span></p>
                        </div>
                        <hr class="bg-body-secondary mb-2 mt-2" />
                        <div class="d-flex align-items-center mb-1">
                            <span class="d-inline-block bg-info-light bullet-item me-2"></span>
                            <p class="mb-0 fw-semibold text-body lh-sm flex-1">Product design</p>
                            <h5 class="mb-0 text-body">78</h5>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <span class="d-inline-block bg-warning-light bullet-item me-2"></span>
                            <p class="mb-0 fw-semibold text-body lh-sm flex-1">Development</p>
                            <h5 class="mb-0 text-body">63</h5>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <span class="d-inline-block bg-danger-light bullet-item me-2"></span>
                            <p class="mb-0 fw-semibold text-body lh-sm flex-1">QA &amp; Testing</p>
                            <h5 class="mb-0 text-body">56</h5>
                        </div>
                        <div class="d-flex align-items-center mb-1">
                            <span class="d-inline-block bg-success-light bullet-item me-2"></span>
                            <p class="mb-0 fw-semibold text-body lh-sm flex-1">Customer queries</p>
                            <h5 class="mb-0 text-body">36</h5>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="d-inline-block bg-primary bullet-item me-2"></span>
                            <p class="mb-0 fw-semibold text-body lh-sm flex-1">R &amp; D</p>
                            <h5 class="mb-0 text-body">24</h5>
                        </div>
                        <button class="btn btn-outline-primary mt-5">See Details<span class="fas fa-angle-right ms-2 fs-10 text-center"></span></button>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="position-relative mb-sm-4 mb-xl-0">
                            <div class="echart-issue-chart" style="min-height:390px;width:100%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-xl-5 col-xxl-6">

                <h3>Project: eleven Progress
                <button class="btn btn-link p-0 text-body fs-6" type="button" id="projects-button" data-bs-toggle="tooltip" data-bs-placement="top" title="Chatbot for projects">
                    <span class="fa-solid fa-info-circle"></span>
                </button>
                <p class="text-body-tertiary mb-0 mb-xl-3">Deadline &amp; progress</p>
                
                <div class="echart-zero-burnout-chart" style="min-height:320px;width:100%"></div>
            </div>
        </div>
    </div>
    <div class="mx-lg-n4 mt-3">
        <div class="row g-3">
            <div class="col-12 col-xl-6 col-xxl-7">
                <div class="card todo-list h-100">
                    <div class="card-header border-bottom-0 pb-0">
                        <div class="row justify-content-between align-items-center mb-4">
                            <div class="col-auto">
                                <h3 class="text-body-emphasis">To do
                                <button class="btn btn-link p-0 text-body fs-6" type="button" id="tasks-button" data-bs-toggle="tooltip" data-bs-placement="top" title="Chatbot for Tasks">
                                    <span class="fa-solid fa-info-circle"></span>
                                </button></h3>
                                <p class="mb-2 mb-md-0 mb-lg-2 text-body-tertiary">Task assigned to me</p>
                            </div>
                            <div class="col-auto w-100 w-md-auto">
                                <div class="row align-items-center g-0 justify-content-between">
                                    <div class="col-12 col-sm-auto">
                                        <div class="search-box w-100 mb-2 mb-sm-0" style="max-width:30rem;">
                                            <form class="position-relative">
                                                <input class="form-control search-input search" type="search" placeholder="Search tasks" aria-label="Search" />
                                                <span class="fas fa-search search-box-icon"></span>

                                            </form>
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex">
                                        <p class="mb-0 ms-sm-3 fs-9 text-body-tertiary fw-bold"><span class="fas fa-filter me-1 fw-extra-bold fs-10"></span>Tasks</p>
                                        <button class="btn btn-link p-0 ms-3 fs-9 text-primary fw-bold"><span class="fas fa-sort me-1 fw-extra-bold fs-10"></span>Sorting</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-0 scrollbar to-do-list-body">
                        <!-- Dynamic tasks will be loaded here -->
                    </div>
                    <div class="card-footer border-0"><a class="fw-bold fs-9 mt-4" href="#!"><span class="fas fa-plus me-1"></span>Add new task</a></div>
                </div>
                <script>
                    document.addEventListener("DOMContentLoaded", async function () {
                        try {
                            // Fetch tasks from the FastAPI backend
                            let response = await fetch("http://127.0.0.1:8000/task/tasks");
                            let tasks = await response.json();

                            // Get the container where tasks will be added
                            let taskContainer = document.querySelector(".to-do-list-body");

                            // Clear existing tasks (if any)
                            taskContainer.innerHTML = "";

                            // Loop through tasks and create dynamic elements
                            tasks.forEach(task => {
                                let taskHTML = `
                                    <div class="d-flex hover-actions-trigger py-3 border-translucent border-top">
                                        <input class="form-check-input form-check-input-todolist flex-shrink-0 my-1 me-2" type="checkbox" id="checkbox-todo-${task.id}" />
                                        <div class="row justify-content-between align-items-md-center btn-reveal-trigger border-translucent gx-0 flex-1 cursor-pointer" data-bs-toggle="modal">
                                            <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
                                                <div class="mb-1 mb-md-0 d-flex align-items-center lh-1">
                                                    <label class="form-check-label mb-1 fs-8 me-2">${task.name}</label>
                                                    <span class="badge ${getStatusClass(task.status)} ms-auto fs-10">${task.status}</span>
                                                </div>
                                            </div>
                                            <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
                                                <div class="d-flex lh-1 align-items-center">
                                                    <a class="text-body-tertiary fw-bold fs-10 me-2" href="#!">
                                                        <span class="badge ${getpriority(task.priority)} ms-auto fs-10">${task.priority}</span>
                                                    </a>
                                                    <p class="text-body-tertiary fs-10 mb-md-0 me-2">${formatDate(task.due_date)}</p>
                                                    <p class="text-body-tertiary fs-10 fw-bold mb-md-0">${task.entity_type}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-none d-md-block d-xl-none d-xxl-block end-0 position-absolute" style="top: 23%;">
                                            <div class="hover-actions end-0">
                                                <button class="btn btn-phoenix-secondary btn-icon me-1 fs-10 text-body px-0"><span class="fas fa-edit"></span></button>
                                                <button class="btn btn-phoenix-secondary btn-icon fs-10 text-danger px-0"><span class="fas fa-trash"></span></button>
                                            </div>
                                        </div>
                                    </div>
                                `;

                                // Append the task to the task list
                                taskContainer.innerHTML += taskHTML;
                            });
                        } catch (error) {
                            console.error("Error fetching tasks:", error);
                        }
                    });

                    // Function to format the date
                    function formatDate(datetimeStr) {
                        if (!datetimeStr) return "N/A";

                        try {
                            const date = new Date(datetimeStr);
                            return date.toLocaleDateString("en-US", {
                                year: "numeric",
                                month: "short",
                                day: "numeric"
                            }); // Example: "Apr 3, 2025"
                        } catch (e) {
                            console.error("Date parsing error:", e);
                            return "Invalid Date";
                        }
                    }

                    // Function to return a CSS class based on status
                    function getStatusClass(status) {
                        switch (status?.toLowerCase()) {
                            case "completed":
                                return "bg-success text-white"; // Green
                            case "in progress":
                                return "bg-warning text-dark"; // Yellow
                            case "pending":
                                return "bg-secondary text-white"; // Gray
                            case "delayed":
                                return "bg-danger text-white"; // Red
                            default:
                                return "bg-light text-dark"; // Default color
                        }
                    }
                     // Function to return a CSS class based on status
                    function getpriority(priority) {
                        switch (priority?.toLowerCase()) {
                            case "low":
                                return "bg-success text-white"; // Green
                            case "medium":
                                return "bg-warning text-dark"; // Yellow
                            case "high":
                                return "bg-danger text-white"; // Red
                            default:
                                return "bg-light text-dark"; // Default color
                        }
                    }
                </script>
            </div>
            <div class="col-12 col-xl-6 col-xxl-5">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="card-title mb-1">
                            <h3 class="text-body-emphasis">Activity
                            <button class="btn btn-link p-0 text-body fs-6" type="button" id="activity-button" data-bs-toggle="tooltip" data-bs-placement="top" title="Chatbot for Activity">
                                    <span class="fa-solid fa-info-circle"></span>
                                </button></h3>
                        </div>
                        <p class="text-body-tertiary mb-4">Recent activity across all projects</p>
                        <div class="timeline-vertical timeline-with-details">
                            <div class="timeline-item position-relative">
                                <div class="row g-md-3">
                                    <div class="col-12 col-md-auto d-flex">
                                        <div class="timeline-item-date order-1 order-md-0 me-md-4">
                                            <p class="fs-10 fw-semibold text-body-tertiary text-opacity-85 text-end">01 DEC, 2023<br class="d-none d-md-block" /> 10:30 AM</p>
                                        </div>
                                        <div class="timeline-item-bar position-md-relative me-3 me-md-0">
                                            <div class="icon-item icon-item-sm rounded-7 shadow-none bg-primary-subtle"><span class="fa-solid fa-chess text-primary-dark fs-10"></span></div><span class="timeline-bar border-end border-dashed"></span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="timeline-item-content ps-6 ps-md-3">
                                            <h5 class="fs-9 lh-sm">Phoenix Template: Unleashing Creative Possibilities</h5>
                                            <p class="fs-9">by <a class="fw-semibold" href="#!">Shantinon Mekalan</a></p>
                                            <p class="fs-9 text-body-secondary mb-5">Discover limitless creativity with the Phoenix template! Our latest update offers an array of innovative features and design options.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-item position-relative">
                                <div class="row g-md-3">
                                    <div class="col-12 col-md-auto d-flex">
                                        <div class="timeline-item-date order-1 order-md-0 me-md-4">
                                            <p class="fs-10 fw-semibold text-body-tertiary text-opacity-85 text-end">05 DEC, 2023<br class="d-none d-md-block" /> 12:30 AM</p>
                                        </div>
                                        <div class="timeline-item-bar position-md-relative me-3 me-md-0">
                                            <div class="icon-item icon-item-sm rounded-7 shadow-none bg-primary-subtle"><span class="fa-solid fa-dove text-primary-dark fs-10"></span></div><span class="timeline-bar border-end border-dashed"></span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="timeline-item-content ps-6 ps-md-3">
                                            <h5 class="fs-9 lh-sm">Empower Your Digital Presence: The Phoenix Template Unveiled</h5>
                                            <p class="fs-9">by <a class="fw-semibold" href="#!">Bookworm22</a></p>
                                            <p class="fs-9 text-body-secondary mb-5">Unveiling the Phoenix template, a game-changer for your digital presence. With its powerful features and sleek design,</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-item position-relative">
                                <div class="row g-md-3">
                                    <div class="col-12 col-md-auto d-flex">
                                        <div class="timeline-item-date order-1 order-md-0 me-md-4">
                                            <p class="fs-10 fw-semibold text-body-tertiary text-opacity-85 text-end">15 DEC, 2023<br class="d-none d-md-block" /> 2:30 AM</p>
                                        </div>
                                        <div class="timeline-item-bar position-md-relative me-3 me-md-0">
                                            <div class="icon-item icon-item-sm rounded-7 shadow-none bg-primary-subtle"><span class="fa-solid fa-dungeon text-primary-dark fs-10"></span></div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="timeline-item-content ps-6 ps-md-3">
                                            <h5 class="fs-9 lh-sm">Phoenix Template: Simplified Design, Maximum Impact</h5>
                                            <p class="fs-9">by <a class="fw-semibold" href="#!">Sharuka Nijibum</a></p>
                                            <p class="fs-9 text-body-secondary mb-0">Introducing the Phoenix template, where simplified design meets maximum impact. Elevate your digital presence with its sleek and intuitive features.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-6 border-top">
                <div id="projectSummary" data-list='{"valueNames":["project","assignees","start","deadline","calculation","projectprogress","status","action"],"page":6,"pagination":true}'>
                    <div class="row align-items-end justify-content-between pb-4 g-3">
                        <div class="col-auto">
                            <h3>Projects</h3>
                            <p class="text-body-tertiary lh-sm mb-0">Brief summary of all projects</p>
                        </div>
                    </div>
                    <div class="table-responsive ms-n1 ps-1 scrollbar">
                        <table class="table fs-9 mb-0 border-top border-translucent">
                            <thead>
                                <tr>
                                    <th class="sort white-space-nowrap align-middle ps-0" scope="col" data-sort="project" style="width:30%;">PROJECT NAME</th>
                                    <th class="sort align-middle ps-3" scope="col" data-sort="start" style="width:10%;">START DATE</th>
                                    <th class="sort align-middle ps-3" scope="col" data-sort="deadline" style="width:15%;">DEADLINE</th>
                                    <th class="sort align-middle ps-3" scope="col" data-sort="calculation" style="width:12%;">TOTAL BUDGET</th>
                                    <th class="sort align-middle ps-3" scope="col" data-sort="projectprogress" style="width:5%;">FUNDING SOURCE</th>
                                    <th class="align-middle ps-8" scope="col" data-sort="status" style="width:10%;">STATUS</th>
                                    <th class="sort align-middle text-end" scope="col" style="width:10%;"></th>
                                </tr>
                            </thead>
                            <tbody class="list" id="project-summary-table-body">
                                <script>
                                    $(document).ready(function () {
                                         fetchProjects();
                                     });

                                     function fetchProjects() {
                                         $.ajax({
                                             url: "http://127.0.0.1:8000/project/projects", // API Endpoint
                                             type: "GET",
                                             dataType: "json",
                                             success: function (data) {
                                                 if (Array.isArray(data)) {
                                                     $("#project-summary-table-body").empty(); // Clear existing rows

                                                     data.forEach(project => {
                                                         $("#project-summary-table-body").append(`
                                                             <tr>
                                                                 <td class="align-middle ps-0">${project.name}</td>
                                                                 <td class="align-middle ps-3">${formatDate(project.start_date)}</td>
                                                                 <td class="align-middle ps-3">${formatDate(project.end_date)}</td>
                                                                 <td class="align-middle ps-3">${project.total_budget}</td>
                                                                 <td class="align-middle ps-3">${project.funding_source }</td>
                                                                 <td class="align-middle ps-8"><span class="badge ${getStatusClass(project.status)}">${project.status}</span></td>
                                                             </tr>
                                                         `);
                                                     });
                                                 } else {
                                                     console.error("Unexpected API response:", data);
                                                 }
                                             },
                                             error: function (xhr, status, error) {
                                                 console.error("AJAX Error:", status, error);
                                             }
                                         });
                                     }

                                     // Function to format date (extract YYYY-MM-DD from ISO format)
                                     function formatDate(datetimeStr) {
                                         if (!datetimeStr) return "N/A";

                                         try {
                                             return datetimeStr.split("T")[0]; // Extracts only YYYY-MM-DD
                                         } catch (e) {
                                             console.error("Date parsing error:", e);
                                             return "Invalid Date";
                                         }
                                     }

                                     // Function to return a CSS class based on status
                                       function getStatusClass(status) {
                                           switch (status?.toLowerCase()) {
                                               case "completed":
                                                   return "bg-success text-white"; // Green
                                               case "in progress":
                                                   return "bg-warning text-dark"; // Yellow
                                               case "pending":
                                                   return "bg-secondary text-white"; // Gray
                                               case "delayed":
                                                   return "bg-danger text-white"; // Red
                                               default:
                                                   return "bg-light text-dark"; // Default color
                                           }
                                       }

                                </script>
                            </tbody>
                        </table>
                    </div>
                    <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
                        <div class="col-auto d-flex">
                            <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
                        </div>
                        <div class="col-auto d-flex">
                            <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
                            <ul class="mb-0 pagination"></ul>
                            <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer position-absolute">
        <div class="row g-0 justify-content-between align-items-center h-100">
            <div class="col-12 col-sm-auto text-center">
                <p class="mb-0 mt-2 mt-sm-0 text-body">Thank you for Visiting Algo Orange<span class="d-none d-sm-inline-block"></span><span class="d-none d-sm-inline-block mx-1">|</span><br class="d-sm-none" />2025 &copy;</p>
            </div>
            <div class="col-12 col-sm-auto text-center">
                <p class="mb-0 text-body-tertiary text-opacity-85">v1.0</p>
            </div>
        </div>
    </footer>
</div>
<!-- Floating Chatbox -->
<div id="chat-container" style="
  display: none;
  position: absolute;
  top: 640px;
  left: 620px;
  width: 280px;
  height: 350px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 15px;
  box-shadow: 0px 5px 15px rgba(46, 46, 46, 0.2);
  z-index: 9999;
  flex-direction: column;
  overflow: hidden;
  font-family: sans-serif;
">
  <!-- Header -->
  <div id="chat-header" style="
    background-color: rgb(38, 73, 233);
    color: rgb(201, 247, 243);
    padding: 10px;
    font-weight: bold;
    cursor: move;
  ">
    <img src="~/assets/img/icons/icon.png" alt="phoenix" width="25" />
    <span id="chat-title">Ask Algo</span>
    <span style="float:right; cursor:pointer;" onclick="closeChat()">✖</span>
  </div>

  <!-- Messages -->
  <div id="chat-messages" style="flex: 1; padding: 10px; overflow-y: auto; height: 220px; background-color: #f9f9f9;"></div>

  <!-- Input -->
  <div style="padding: 10px; border-top: 1px solid #ddd;">
    <input type="text" id="chat-input" placeholder="Type a message..." style="width: 75%; padding: 5px; border-radius:10px">
    <button onclick="projectchatbotsendMessage()" style="padding: 6px 10px; background:#eccdb3; color: white; border: none; border-radius: 10px;">Send</button>
  </div>
</div>


<script>
  let currentContext = "";

  const contextApiMap = {
  "Projects": "http://127.0.0.1:8000/chat/query",
  "Issues": "http://127.0.0.1:8000/chat/issues",
  "Tasks": "http://127.0.0.1:8000/chat/query",
  "Activity": "http://127.0.0.1:8000/chat/query"
  };

function openChat(event, context) {
  currentContext = context;

  const chat = document.getElementById("chat-container");
  const chatTitle = document.getElementById("chat-title");
  const chatMessages = document.getElementById("chat-messages");

  // Set the chatbot title and welcome message
  chatTitle.textContent = `Ask Algo (${context})`;
  chatMessages.innerHTML = `<div class="welcome-message" style="text-align: center; color: #888;">Welcome to the ${context} chatbot!</div>`;
  

  // Position the chatbox near the button
  const buttonRect = event.target.getBoundingClientRect();
  chat.style.top = `${buttonRect.bottom + window.scrollY + 10}px`;
  chat.style.left = `${buttonRect.left + window.scrollX}px`;

  // Show the chatbox with animation
  chat.style.display = "flex";
  setTimeout(() => {
    chat.classList.add("active");
  }, 10); // Add a slight delay to trigger the animation
}

function closeChat() {
  const chat = document.getElementById("chat-container");

  // Hide the chatbox with animation
  chat.classList.remove("active");
  setTimeout(() => {
    chat.style.display = "none";
  }, 300); // Match the duration of the CSS transition
}

  async function projectchatbotsendMessage() {
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    if (!msg || !currentContext) return;

    const chatBody = document.getElementById("chat-messages");

    // Remove welcome message if it exists
        const welcomeMessage = chatBody.querySelector(".welcome-message");
        if (welcomeMessage) {
        welcomeMessage.remove();
        }

    // Show user message                                           
    const userDiv = document.createElement("div");
    userDiv.style.textAlign = "right";
    userDiv.innerHTML = `<div style="background:#f5f5f5; padding:5px 10px; border-radius:10px; margin:4px 0; display:inline-block;">${msg}</div>`;
    chatBody.appendChild(userDiv);

    input.value = "";

    try {
      const endpoint = contextApiMap[currentContext];
      if (!endpoint) throw new Error("Invalid context");

        const response = await fetch(`${endpoint}?userChatQuery=${encodeURIComponent(msg)}`, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      });

      const data = await response.json();
      const botReply = data.response || "No response";

      const botDiv = document.createElement("div");
      botDiv.style.textAlign = "left";
      botDiv.innerHTML = `<div style="background:#f9f9f9; padding:5px 10px; border-radius:10px; margin:4px 0; display:inline-block;">${botReply}</div>`;
      chatBody.appendChild(botDiv);
      chatBody.scrollTop = chatBody.scrollHeight;

    } catch (error) {
      console.error("Chat error:", error);
      const errorDiv = document.createElement("div");
      errorDiv.style.textAlign = "left";
      errorDiv.innerHTML = `<div style="color:red; margin:4px 0;">Error: ${error.message}</div>`;
      chatBody.appendChild(errorDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
  }

// Make chat draggable
const chatContainer = document.getElementById("chat-container");
const chatHeader = document.getElementById("chat-header");
let offsetX = 0,
  offsetY = 0,
  isDragging = false;

chatHeader.addEventListener("mousedown", function (e) {
  isDragging = true;

  // Disable transition for instant movement
  chatContainer.classList.add("no-transition");

  offsetX = e.clientX - chatContainer.offsetLeft;
  offsetY = e.clientY - chatContainer.offsetTop;
});

document.addEventListener("mousemove", function (e) {
  if (isDragging) {
    chatContainer.style.left = `${e.clientX - offsetX}px`;
    chatContainer.style.top = `${e.clientY - offsetY}px`;
  }
});

document.addEventListener("mouseup", function () {
  if (isDragging) {
    isDragging = false;

    // Re-enable transition after dragging
    chatContainer.classList.remove("no-transition");
  }
});


  // Button bindings
  document.getElementById("projects-button").addEventListener("click", function (e) {
    openChat(e, "Projects");
  });

  document.getElementById("Issues-button").addEventListener("click", function (e) {
    openChat(e, "Issues");
  });

  document.getElementById("tasks-button").addEventListener("click", function (e) {
    openChat(e, "Tasks");
  });

  document.getElementById("activity-button").addEventListener("click", function (e) {
    openChat(e, "Activity");
  });
</script>

<script>
$(document).ready(function(){
    $('<script/>',{type:'text/javascript', src:'/assets/js/dashboards/projectmanagement-dashboard.js'}).appendTo('head');
 }); 
</script>

<style>
  /* Initial state for the popup */
  #chat-container {
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.4s ease-in-out; /* Smooth animation for opacity and scale */
  }

  /* When the popup is active */
  #chat-container.active {
    opacity: 1;
    transform: scale(1);
  }

  /* Disable transition for position changes (instant movement) */
  #chat-container.no-transition {
    transition: none; /* Disable transition for instant movement */
  }

  /* Close button hover effect */
  #chat-header span:hover {
    color: #ff4d4d;
  }
</style>
